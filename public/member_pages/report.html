<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Reports - UNZAGYM</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-weight-hanging"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>UNZAGYM</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="announcements.html"><svg xmlns="http://www.w3.org/2000/svg"
                                width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16"
                                class="bi bi-megaphone-fill">
                                <path d="M13 2.5a1.5 1.5 0 0 1 3 0v11a1.5 1.5 0 0 1-3 0v-11zm-1 .724c-2.067.95-4.539 1.481-7 1.656v6.237a25.222 25.222 0 0 1 1.088.085c2.053.204 4.038.668 5.912 1.56V3.224zm-8 7.841V4.934c-.68.027-1.399.043-2.008.053A2.02 2.02 0 0 0 0 7v2c0 1.106.896 1.996 1.994 2.009a68.14 68.14 0 0 1 .496.008 64 64 0 0 1 1.51.048zm1.39 1.081c.285.021.569.047.85.078l.253 1.69a1 1 0 0 1-.983 1.187h-.548a1 1 0 0 1-.916-.599l-1.314-2.48a65.81 65.81 0 0 1 1.692.064c.327.017.65.037.966.06z">
                                </path>
                            </svg><span>Announcements</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="login_history.html"><i class="fas fa-table"></i><span>Login History</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="payment_history.html"><svg xmlns="http://www.w3.org/2000/svg"
                                width="1em" height="1em" viewBox="0 0 24 24" fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M6.47005 3.54443H14.4701C16.1089 3.54443 17.4146 4.31866 18.0963 5.51496C19.3165 6.38743 19.9427 7.91487 19.6082 9.65332C19.0865 12.365 16.425 14.5633 13.6636 14.5633H11.6636L10.5301 20.4553H6.39824L6.62891 19.2563H3.44727L6.47005 3.54443ZM8.0922 5.50842H14.0922C15.7491 5.50842 16.8385 6.82737 16.5254 8.45439C16.2124 10.0814 14.6155 11.4004 12.9587 11.4004H8.95866L7.82511 17.2923H5.82511L8.0922 5.50842Z"
                                    fill="currentColor"></path>
                            </svg><span>Payment History</span></a></li>
                    <li class="nav-item"><a class="nav-link active" href="report.html"><svg xmlns="http://www.w3.org/2000/svg"
                                width="1em" height="1em" viewBox="0 0 24 24" fill="none">
                                <path d="M9 17V15M12 17V13M15 17V11M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg><span>Report</span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle"
                        type="button"></button></div>
            </div>
        </nav>

        <!-- Content Wrapper -->
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-light navbar-expand shadow mb-4 topbar static-top">
                    <div class="container-fluid">
                        <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i
                                class="fas fa-bars"></i></button>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow">
                                    <a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown"
                                        href="#">
                                        <i class="fas fa-user-alt fs-4" id="profile_icon"></i>
                                        <span class="fs-6 fw-bold d-none d-lg-inline me-2 text-gray-600 small"
                                            id="username">Valerie Luna</span>
                                    </a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in">
                                        <a class="dropdown-item" href="profile.html"><i
                                                class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Profile</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#" id="logoutBtn"><i
                                                class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Logout</a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>

                <div class="container-fluid">
                    <!-- Submit Report Card -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="text-primary m-0 fw-bold">Submit a Report</h6>
                        </div>
                        <div class="card-body">
                            <form method="post" id="reportForm">
                                <label class="form-label" for="reportSubject">Report Subject</label>
                                <input class="form-control" type="text" id="reportSubject" name="subject">

                                <label class="form-label" for="reportDescription">Description</label>
                                <textarea class="form-control form-control-lg" id="reportDescription" name="description"></textarea>

                                <hr>
                                <button class="btn btn-primary" id="send_report_btn" type="submit">Send Report</button>
                            </form>
                        </div>
                    </div>

                    <!-- Report History Card -->
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h6 id="report_history" class="m-0">Report History</h6>
                        </div>
                        <div class="card-body" id="reportHistoryContainer">
                            <p class="text-muted">Loading reports...</p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright Â© UNZA 2025</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/theme.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const reportForm = document.getElementById("reportForm");
            const sendReportBtn = document.getElementById("send_report_btn");
            const reportHistoryContainer = document.getElementById("reportHistoryContainer");

            const token = localStorage.getItem("memberToken") || sessionStorage.getItem("memberToken");

            if (!token) {
                alert("You must log in first.");
                window.location.href = "/login.html";
                return;
            }

            async function loadReports() {
                try {
                    const res = await fetch("/api/member/reports", {
                        headers: { "Authorization": "Bearer " + token }
                    });
                    const data = await res.json();

                    reportHistoryContainer.innerHTML = "";
                    if (!data.success || !data.reports || data.reports.length === 0) {
                        reportHistoryContainer.innerHTML = `<p class="text-muted">No reports submitted yet.</p>`;
                        return;
                    }

                    data.reports.forEach((report, index) => {
                        const card = document.createElement("div");
                        card.className = "shadow card mb-2";
                        card.innerHTML = `
                            <a class="btn btn-link text-start card-header fw-bold" data-bs-toggle="collapse"
                                aria-expanded="${index === 0}" aria-controls="collapseReport${index}" href="#collapseReport${index}" role="button">
                                Subject: ${report.subject}
                            </a>
                            <div class="collapse ${index === 0 ? "show" : ""}" id="collapseReport${index}">
                                <div class="card-body">
                                    ${report.message}
                                    <hr>
                                    <small class="text-muted">Submitted on: ${new Date(report.submitted_at).toLocaleString()}</small>
                                </div>
                            </div>
                        `;
                        reportHistoryContainer.appendChild(card);
                    });
                } catch (err) {
                    console.error(err);
                    reportHistoryContainer.innerHTML = `<p class="text-danger">Error loading reports</p>`;
                }
            }

            reportForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                sendReportBtn.disabled = true;
                sendReportBtn.textContent = "Sending...";

                const subject = document.getElementById("reportSubject").value.trim();
                const description = document.getElementById("reportDescription").value.trim();

                if (!subject || !description) {
                    alert("Please fill in both fields.");
                    sendReportBtn.disabled = false;
                    sendReportBtn.textContent = "Send Report";
                    return;
                }

                try {
                    const res = await fetch("/api/member/reports", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({ subject, description })
                    });
                    const result = await res.json();

                    if (res.ok && result.success) {
                        alert("Report submitted successfully!");
                        reportForm.reset();
                        loadReports();
                    } else {
                        alert("Failed to submit report: " + (result.message || "Unknown error"));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Something went wrong.");
                }

                sendReportBtn.disabled = false;
                sendReportBtn.textContent = "Send Report";
            });

            loadReports();
        });
    </script>

     <!-- Shared Auth Script -->
    <script src="memberAuth.js"></script>
</body>
</html>
